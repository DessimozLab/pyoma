import unittest
from pyoma.browser import locus_parser as lp

class LocusParserTest(unittest.TestCase):
    
    def verifyResult(self, res, eNr, nr_exons, min_loc, max_loc, strand):
        self.assertEqual(res.shape, (nr_exons,))
        for x in res.EntryNr:
            self.assertEqual(x,eNr)
        self.assertEqual(res.Start.min(), min_loc)
        self.assertEqual(res.End.max(),max_loc)
        self.assertEqual(res[0].Strand, strand)

    def test_singleExonForward(self):
        s, eNr = '422..522', 22
        res = lp.parse(eNr, s)
        self.verifyResult(res, eNr, 1, 422, 522, 1)

    def test_singleExonReverse(self):
        s, eNr = 'complement(22..6232)', 21
        res = lp.parse(eNr, s)
        self.verifyResult(res, eNr, 1, 22, 6232, -1)

    def test_forward(self):
        s, eNr = 'join(23..15555,22432..66666)', 5
        res = lp.parse(eNr, s)
        self.verifyResult(res, eNr, 2, 23, 66666, 1)

    def test_reverse(self):
        s, eNr = 'join(complement(23..15555),complement(22432..66666))', 5
        res = lp.parse(eNr, s)
        self.verifyResult(res, eNr, 2, 23, 66666, -1)

    def test_before_and_after(self):
        s, eNr = 'join(Before(10)..40,33..After(66))', 8
        res = lp.parse(eNr, s)
        self.verifyResult(res, eNr, 2, 10, 66, 1)

    def test_complement_of_join(self):
        s, eNr = 'complement(join(1653679..1653924,1654352..1654354))', 333
        res = lp.parse(eNr, s)
        self.verifyResult(res, eNr, 2, 1653679, 1654354, -1)

    def test_huge(self):
        """parsing fails when too many exons are joined"""
        s, eNr = "join(1174265..1174355, 1178881..1179084, 1180046..1180333, 1181738..1181826, 1181919..1182163, 1185501..1185801, 1186022..1186174, 1186664..1186780, 1188317..1188473, 1188974..1189054, 1189186..1189226, 1190422..1190559, 1191014..1191151, 1193561..1193827, 1193948..1194073, 1195349..1195627, 1195944..1196009, 1196485..1196743, 1198381..1198441, 1198559..1198771, 1199556..1199698, 1200742..1200947, 1201081..1201311, 1201891..1202135, 1202360..1202416, 1202691..1202914, 1203018..1203182, 1203281..1203449, 1203982..1205672, 1205824..1206105, 1206383..1206649, 1206754..1207026, 1207140..1207403, 1207496..1207756, 1208137..1208397, 1208880..1209143, 1209249..1209509, 1209656..1209916, 1211012..1211272, 1211369..1211510, 1211597..1211762, 1212356..1212587, 1213383..1213667, 1213771..1213896, 1217624..1217812, 1223196..1223252, 1238244..1239107, 1239524..1239554, 1240062..1240215, 1240354..1240753, 1240796..1241480, 1241718..1241970, 1242013..1242328, 1243136..1243414, 1244538..1245104, 1245563..1245844, 1245942..1246220, 1246707..1246991, 1247088..1247366, 1247495..1247782, 1247901..1248179, 1248308..1248589, 1248689..1248967, 1249060..1249338, 1249455..1249733, 1249848..1250135, 1250254..1250532, 1250621..1250908, 1251016..1251294, 1251407..1251694, 1251803..1252081, 1252213..1252500, 1252757..1253035, 1253272..1253553, 1254161..1254439, 1254551..1254832, 1255520..1255798, 1255898..1256185, 1256410..1256688, 1256785..1257063, 1257157..1257435, 1257554..1257841, 1257969..1258256, 1259167..1259448, 1260451..1260729, 1260830..1261117, 1261226..1261504, 1261624..1261911, 1262064..1262348, 1262495..1262773, 1262878..1263156, 1263276..1263563, 1263701..1263988, 1265485..1265766, 1265974..1266252, 1266352..1266633, 1266724..1267002, 1267524..1267811, 1281619..1281897, 1281986..1282264, 1282356..1282634, 1283271..1283558, 1283709..1283996, 1284580..1284870, 1297808..1298095, 1299448..1299540, 1299658..1299940, 1300287..1300473, 1301181..1301270, 1301371..1301638, 1316151..1316411, 1317025..1317234, 1317336..1317413, 1317522..1317548, 1318429..1318476, 1320438..1320494, 1320611..1320688, 1322960..1323014, 1323723..1323988, 1325314..1325383, 1326019..1326107, 1326810..1326890, 1327499..1327582, 1327805..1327879, 1328112..1328189, 1328543..1328626, 1329154..1329237, 1329427..1329476, 1329824..1329908, 1330061..1330144, 1330445..1330504, 1331718..1331833, 1332029..1332099, 1332234..1332246, 1332356..1332458, 1332803..1332880, 1333096..1333157, 1333322..1333344, 1333816..1333866, 1334581..1334611, 1335713..1335762, 1335777..1335790, 1337059..1337142, 1337241..1337320, 1337664..1337706, 1338798..1338826, 1339275..1339338, 1339499..1339552, 1339792..1339866, 1339921..1339950, 1340466..1340594, 1340729..1340767, 1341030..1341128, 1341343..1341370, 1341402..1341444, 1341667..1341696, 1342174..1342270, 1342458..1342538, 1342824..1342907, 1343903..1343986, 1348670..1348753, 1348982..1349230, 1350353..1350372, 1351620..1351695, 1352380..1352463)", 6213345    
        res = lp.parse(eNr, s)
        self.verifyResult(res, eNr, 165, 1174265, 1352463, 1)
